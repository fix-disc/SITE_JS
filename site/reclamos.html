<!DOCTYPE html>
<html lang="es">
    <head>
<style>
.tabla_datos td, .tabla_datos th {
    user-select: text;
    -webkit-user-select: text;
    -moz-user-select: text;
    -ms-user-select: text;
}
</style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>LIBRO QUEJAS</title>
        <link id="css" rel="stylesheet" href="../css/style.css">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">
        
        
        <script src="../js/behaviour.js"></script>
    </head>
    <body onload="busca_reclamos();carga_tipos();carga_departamentos();">
        <div id="contenido1" class="contenido1" style="width: 100%;" onmousedown="hide_all()">
            <div style="float: left;">
                 <label for="agno">AÑO</label><br>
                <select id="agno" onchange="filtros(this.value)">
                    <option value="0">Todos</option>
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
            </div>
            <div style="float: left;">
                <label for="tipo">TIPOS</label><br>
                <select id="tipo" onchange="filtros(this.value)">
                    <option value="0">Todos</option>
                </select>
            </div>
            <div style="float: left;">
                <label for="departamento">DEPTOS.</label><br>
                <select id="departamento" onchange="filtros(this.value)">
                    <option value="0">Todos</option>
                </select>
            </div>
           <br><br><br>&nbsp;&nbsp;TOTAL: <span id="total"></span><br><br>
            <div id="datos">

            </div>

        </div>
    </body>
</html>
<script src="../js/api.js"></script>
<script>

json_reclamos = [];
async function busca_reclamos(){
    await get_reclamos("").then(
        function(res){
            json_reclamos = res;
            console.log("RECLAMOS: " + JSON.stringify(res))
            html = '<table class="tabla_datos" style="user-select: text; -webkit-user-select: text; -moz-user-select: text;">';
            html += '<tr><th class="th1">ID</th><th class="th1">FECHA</th><th class="th1">HORA</th><th class="th1">USUARIO</th><th class="th1">DEPTO.</th><th class="th1">TIPO</th><th class="th1">RECLAMO</th><th class="th1">OBSERVACIONES</th><th class="th1">ACCIONES</th><th class="th1">ESTADO</th></tr>';
            data = res;
            for(v=0;v<data.length;v++){
                //console.log("data: " + JSON.stringify(data[v].id))
                if (data[v].estado=="INGRESADO"){estado_color = "#ff9800";}
                else if (data[v].estado=="EN CURSO"){estado_color = "#6b581c";}
                else if (data[v].estado=="CERRADO"){estado_color = "#a13a06";}
                else{estado_color = "";}
                let obs = "";
                let acciones = "";
                if(data[v].observaciones == ""){
                    obs = '<div class="bot_save" onclick="ingresa_obs(' + data[v].id + ')">INGRESAR</div>';
                    acciones = '';
                }else{
                    obs = data[v].observaciones;
                    acciones = '<div class="bot_cancel" style="width:25px;display:inline-block;text-align:center;margin:auto;cursor:pointer;" title="Eliminar" onclick="elimina_obs(' + data[v].id + ')">X</div>';
                    acciones += '<div class="bot_save" style="width:25px;display:inline-block;text-align:center;margin:auto;cursor:pointer;margin-left:5px;background:#a17806;" title="Modificar" onclick="modifica_obs(' + data[v].id + ')"><i class="fa fa-pencil" style="color:#fff;"></i></div>';
                }
                html += '<tr><td class"td1">' + data[v].id + '</td><td class"td1">' + data[v].fechahora.split(" ")[0] + '</td><td class"td1">' + data[v].fechahora.split(" ")[1] + '<td class"td1">' + data[v].usuario + '</td><td class"td1">' + data[v].departamento + '</td></td><td class"td1">' + data[v].tipo + '</td><td class"td1" style="text-align:left">' + data[v].texto + '</td><td class"td1" style="text-align:left">' + obs + '</td><td class"td1">' + acciones + '</td><td class="td1 estado-reclamo" data-id="' + data[v].id + '" data-estado="' + data[v].estado + '" data-bg="' + estado_color + '" style="background-color:' + (estado_color ? estado_color : '#333') + ';color:#fff;cursor:pointer;text-align:center;">' + data[v].estado + '</td></tr>';
// Evento delegación para activar el selector de estado en la celda (fuera del bucle)
setTimeout(function() {
    document.removeEventListener('click', window._estadoReclamoClick);
    window._estadoReclamoClick = function(e) {
        if(e.target.classList.contains('estado-reclamo')) {
            const td = e.target;
            const id = td.getAttribute('data-id');
            const estadoActual = td.getAttribute('data-estado');
            const estados = ['INGRESADO','EN CURSO','CERRADO'];
            let select = document.createElement('select');
            // Obtener color de fondo de la página
            let pageBg = window.getComputedStyle(document.body).backgroundColor;
            select.style.background = pageBg;
            select.style.color = '#fff';
            select.style.border = '1px solid #888';
            select.style.borderRadius = '4px';
                                setTimeout(function() {
                                    document.removeEventListener('click', window._estadoReclamoClick);
                                    window._estadoReclamoClick = function(e) {
                                        if(e.target.classList.contains('estado-reclamo')) {
                                            const td = e.target;
                                            const id = td.getAttribute('data-id');
                                            const estadoActual = td.getAttribute('data-estado');
                                            const estados = ['INGRESADO','EN CURSO','CERRADO'];
                                            let select = document.createElement('select');
                                            let pageBg = window.getComputedStyle(document.body).backgroundColor;
                                            select.style.background = pageBg;
                                            select.style.color = '#fff';
                                            select.style.border = '1px solid #888';
                                            select.style.borderRadius = '4px';
                                            select.style.padding = '2px 6px';
                                            select.style.fontSize = window.getComputedStyle(td).fontSize;
                                            estados.forEach(e => {
                                                let opt = document.createElement('option');
                                                opt.value = e;
                                                opt.textContent = e;
                                                if(e === estadoActual) opt.selected = true;
                                                select.appendChild(opt);
                                            });
                                            for (let i = 0; i < select.options.length; i++) {
                                                select.options[i].style.fontSize = select.style.fontSize;
                                            }
                                            td.innerHTML = '';
                                            td.appendChild(select);
                                            select.focus();
                                            select.addEventListener('blur', function() {
                                                td.innerHTML = select.value;
                                                td.setAttribute('data-estado', select.value);
                                                td.style.backgroundColor = td.getAttribute('data-bg') || '#333';
                                            });
                                            select.addEventListener('change', function() {
                                                if(select.value !== estadoActual) {
                                                    mod_estado_reclamo(id, select.value).then(function(res){
                                                        if(res.message=="Estado actualizado"){
                                                            busca_reclamos();
                                                        }else{
                                                            alert("Error al actualizar estado");
                                                        }
                                                    });
                                                }
                                            });
                                        }
                                    };
                                    document.addEventListener('click', window._estadoReclamoClick);
                                }, 100);
            estados.forEach(e => {
                let opt = document.createElement('option');
                opt.value = e;
                opt.textContent = e;
                if(e === estadoActual) opt.selected = true;
                select.appendChild(opt);
            });
            td.innerHTML = '';
            td.appendChild(select);
            select.focus();
            select.addEventListener('blur', function() {
                td.innerHTML = select.value;
                td.setAttribute('data-estado', select.value);
                td.style.backgroundColor = td.getAttribute('data-bg') || '#333';
            });
            select.addEventListener('change', function() {
                if(select.value !== estadoActual) {
                    mod_estado_reclamo(id, select.value).then(function(res){
                        if(res.message=="Estado actualizado"){
                            busca_reclamos();
                        }else{
                            alert("Error al actualizar estado");
                        }
                    });
                }
            });
        }
    };
    document.addEventListener('click', window._estadoReclamoClick);
}, 100);
            }
            html += '</table>';
           
            document.getElementById("datos").innerHTML = html;
            document.getElementById("total").innerHTML = data.length;
        }
    )

}

function carga_tipos(){
    get_tipo_reclamo().then(
        function(res){
            console.log("TIPOS: " + JSON.stringify(res))
            html = '<option value="0">Todos</option>';
            for(v=0;v<res.length;v++){
                html += '<option value="' + res[v].id + '">' + res[v].nombre + '</option>';
            }
            document.getElementById("tipo").innerHTML = html;
        }
    )
}

function carga_departamentos(){
    get_departamentos().then(
        function(res){
            console.log("DEPARTAMENTOS: " + JSON.stringify(res))
            html = '<option value="0">Todos</option>';
            for(v=0;v<res.length;v++){
                html += '<option value="' + res[v].departamento + '">' + res[v].departamento + '</option>';
            }
            document.getElementById("departamento").innerHTML = html;
        }
    )
}

function filtro_agno(agno){
    console.log("json: " + JSON.stringify(json_reclamos))
    data = json_reclamos.filter((elem) => elem.fechahora.indexOf(agno)!=-1)

    html = '<table class="tabla_datos">';
    html += '<tr><th class="th1">ID</th><th class="th1">FECHA</th><th class="th1">HORA</th><th class="th1">USUARIO</th><th class="th1">DEPTO.</th><th class="th1">TIPO</th><th class="th1">RECLAMO</th></tr>';

    for(v=0;v<data.length;v++){
        //console.log("data: " + JSON.stringify(data[v].id))
        html += '<tr><td class"td1">' + data[v].id + '</td><td class"td1">' + data[v].fechahora.split(" ")[0] + '</td><td class"td1">' + data[v].fechahora.split(" ")[1] + '<td class"td1">' + data[v].usuario + '</td><td class"td1">' + data[v].departamento + '</td></td><td class"td1">' + data[v].tipo + '</td><td class"td1" style="text-align:left">' + data[v].texto + '</td></tr>';
    }
    html += '</table>';

    document.getElementById("datos").innerHTML = html;
    document.getElementById("total").innerHTML = data.length;
}


async function filtros(){
    if(document.getElementById("agno").value!="0"){f1 = document.getElementById("agno").value;}else{f1 = "0";} 
    if(document.getElementById("tipo").value!="0"){f2 = document.getElementById("tipo").value;}else{f2 = "0";}
    if(document.getElementById("departamento").value!="0"){f3 = document.getElementById("departamento").value;}else{f3 = "0";}
    params = f1+","+f2+","+f3;
    await get_reclamos_filtro(params).then(
        function(res){
            json_reclamos = res;
            html = '<table class="tabla_datos">';
            html += '<tr><th class="th1">ID</th><th class="th1">FECHA</th><th class="th1">HORA</th><th class="th1">USUARIO</th><th class="th1">DEPTO.</th><th class="th1">TIPO</th><th class="th1">RECLAMO</th><th class="th1">OBSERVACIONES</th><th class="th1">ACCIONES</th><th class="th1">ESTADO</th></tr>';
            data = res;
            for(v=0;v<data.length;v++){
                let estado_color = "";
                if (data[v].estado=="INGRESADO"){estado_color = "#ff9800";}
                else if (data[v].estado=="EN CURSO"){estado_color = "#6b581c";}
                else if (data[v].estado=="CERRADO"){estado_color = "#a13a06";}
                let obs = "";
                let acciones = "";
                if(data[v].observaciones == ""){
                    obs = '<div class="bot_save" onclick="ingresa_obs(' + data[v].id + ')">INGRESAR</div>';
                    acciones = '';
                }else{
                    obs = data[v].observaciones;
                    acciones = '<div class="bot_cancel" style="width:25px;display:inline-block;text-align:center;margin:auto;cursor:pointer;" title="Eliminar" onclick="elimina_obs(' + data[v].id + ')">X</div>';
                    acciones += '<div class="bot_save" style="width:25px;display:inline-block;text-align:center;margin:auto;cursor:pointer;margin-left:5px;background:#a17806;" title="Modificar" onclick="modifica_obs(' + data[v].id + ')"><i class="fa fa-pencil" style="color:#fff;"></i></div>';
                }
                html += '<tr><td class"td1">' + data[v].id + '</td><td class"td1">' + data[v].fechahora.split(" ")[0] + '</td><td class"td1">' + data[v].fechahora.split(" ")[1] + '<td class"td1">' + data[v].usuario + '</td><td class"td1">' + data[v].departamento + '</td></td><td class"td1">' + data[v].tipo + '</td><td class"td1" style="text-align:left">' + data[v].texto + '</td><td class"td1" style="text-align:left">' + obs + '</td><td class"td1">' + acciones + '</td><td class="td1 estado-reclamo" data-id="' + data[v].id + '" data-estado="' + data[v].estado + '" data-bg="' + estado_color + '" style="background-color:' + (estado_color ? estado_color : '#333') + ';color:#fff;cursor:pointer;text-align:center;">' + data[v].estado + '</td></tr>';
            }
            html += '</table>';
            document.getElementById("datos").innerHTML = html;
            document.getElementById("total").innerHTML = data.length;
            // Evento delegación para activar el selector de estado en la celda
            setTimeout(function() {
                document.removeEventListener('click', window._estadoReclamoClick);
                window._estadoReclamoClick = function(e) {
                    if(e.target.classList.contains('estado-reclamo')) {
                        const td = e.target;
                        const id = td.getAttribute('data-id');
                        const estadoActual = td.getAttribute('data-estado');
                        const estados = ['INGRESADO','EN CURSO','CERRADO'];
                        let select = document.createElement('select');
                        let pageBg = window.getComputedStyle(document.body).backgroundColor;
                        select.style.background = pageBg;
                        select.style.color = '#fff';
                        select.style.border = '1px solid #888';
                        select.style.borderRadius = '4px';
                        select.style.padding = '2px 6px';
                        select.style.fontSize = window.getComputedStyle(td).fontSize;
                        estados.forEach(e => {
                            let opt = document.createElement('option');
                            opt.value = e;
                            opt.textContent = e;
                            if(e === estadoActual) opt.selected = true;
                            select.appendChild(opt);
                        });
                        for (let i = 0; i < select.options.length; i++) {
                            select.options[i].style.fontSize = select.style.fontSize;
                        }
                        td.innerHTML = '';
                        td.appendChild(select);
                        select.focus();
                        select.addEventListener('blur', function() {
                            td.innerHTML = select.value;
                            td.setAttribute('data-estado', select.value);
                            let color = '';
                            if(select.value=="INGRESADO"){color="#ff9800";}
                            else if(select.value=="EN CURSO"){color="#6b581c";}
                            else if(select.value=="CERRADO"){color="#a13a06";}
                            else{color="#333";}
                            td.style.backgroundColor = color;
                        });
                        select.addEventListener('change', function() {
                            if(select.value !== estadoActual) {
                                mod_estado_reclamo(id, select.value).then(function(res){
                                    if(res.message=="Estado modificado"){
                                        busca_reclamos();
                                    }else{
                                        alert("Error al modificar el estado");
                                    }
                                });
                            }
                        });
                    }
                };
                document.addEventListener('click', window._estadoReclamoClick);
            }, 100);
        }
    );

}

function ingresa_obs(id){
    parent.document.getElementById("modal1").style.display = "block";
    parent.document.getElementById("sel_reclamo").value = id;
}



function modifica_obs(id){
    parent.document.getElementById("modal2").style.display = "block";
    parent.document.getElementById("sel_reclamo").value = id;
}

async function elimina_obs(id){
    if(!confirm("¿Confirma eliminar observación?")){return;}
    await del_observaciones(id).then(
        function(res){
            if(res.message=="Observacion eliminada"){
                alert("Observación eliminada");
                busca_reclamos();
            }else{
                alert("Error al eliminar observación");
            }
        }
    )
}

async function mod_estado_reclamo(id, estado) {
    await mod_reclamos(id, estado).then(
        function(res){
            console.log("RES: " + JSON.stringify(res)) ;
            if(res.message=="Estado modificado"){
                alert("Estado modificado");
                busca_reclamos();
            }else{
                alert("Error al modificar el estado");
            }
        }
    );
}

</script>